{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Dashboard da Biblioteca</h2>
        <p class="lead">Bem-vindo, {{ current_user.nome }}!</p>
    </div>
</div>

<!-- Estat√≠sticas -->
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary mb-3">
            <div class="card-body">
                <h5 class="card-title">Total de Livros</h5>
                <p class="card-text display-6">{{ total_livros }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success mb-3">
            <div class="card-body">
                <h5 class="card-title">Dispon√≠veis</h5>
                <p class="card-text display-6">{{ livros_disponiveis }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning mb-3">
            <div class="card-body">
                <h5 class="card-title">Empr√©stimos</h5>
                <p class="card-text display-6">{{ emprestimos_ativos }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info mb-3">
            <div class="card-body">
                <h5 class="card-title">Vendas</h5>
                <p class="card-text display-6">{{ total_vendas }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Bot√µes de A√ß√£o -->
{% if current_user.is_admin %}
<div class="row mt-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>Gest√£o do Sistema</h4>
            <div>
                <a href="{{ url_for('novo_livro') }}" class="btn btn-primary me-2">üìö Novo Livro</a>
                <a href="{{ url_for('cadastrar_usuario') }}" class="btn btn-success me-2">üë• Novo Usu√°rio</a>
                <a href="{{ url_for('novo_emprestimo') }}" class="btn btn-warning me-2">üìñ Novo Empr√©stimo</a>
                <a href="{{ url_for('nova_venda') }}" class="btn btn-info me-2">üí∞ Nova Venda</a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Se√ß√£o de Empr√©stimos Ativos -->
<div class="row mt-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>üìñ Empr√©stimos Ativos</h4>
            <span class="badge bg-warning">{{ emprestimos|length }} ativos</span>
        </div>

        {% if emprestimos %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead class="table-warning">
                    <tr>
                        <th>Livro</th>
                        <th>Usu√°rio</th>
                        <th>Data Empr√©stimo</th>
                        <th>Dias</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for emprestimo in emprestimos %}
                    <tr>
                        <td><strong>{{ emprestimo.livro.titulo }}</strong></td>
                        <td>{{ emprestimo.usuario.nome }}</td>
                        <td>{{ emprestimo.data_emprestimo.strftime('%d/%m/%Y') }}</td>
                        <td>
                            <span
                                class="badge {% if emprestimo.dias_decorridos > 14 %}bg-danger{% else %}bg-success{% endif %}">
                                {{ emprestimo.dias_decorridos }} dias
                            </span>
                        </td>
                        <td>
                            <a href="{{ url_for('devolver_emprestimo', emprestimo_id=emprestimo.id) }}"
                                class="btn btn-sm btn-success" onclick="return confirm('Marcar \" {{
                                emprestimo.livro.titulo }}\" como devolvido?')">
                                ‚úÖ Devolver
                            </a>
                            {% if current_user.is_admin %}
                            <a href="{{ url_for('cancelar_emprestimo', emprestimo_id=emprestimo.id) }}"
                                class="btn btn-sm btn-danger" onclick="return confirm('Cancelar empr√©stimo de \" {{
                                emprestimo.livro.titulo }}\"?')">
                                ‚ùå Cancelar
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">üìö Nenhum empr√©stimo ativo no momento.</div>
        {% endif %}
    </div>
</div>

<!-- Se√ß√£o de Vendas Recentes -->
<div class="row mt-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>üí∞ Vendas Recentes</h4>
            <span class="badge bg-info">{{ vendas|length }} vendas</span>
        </div>

        {% if vendas %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead class="table-info">
                    <tr>
                        <th>Livro</th>
                        <th>Usu√°rio</th>
                        <th>Pre√ßo</th>
                        <th>Data Venda</th>
                        {% if current_user.is_admin %}
                        <th>A√ß√µes</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for venda in vendas %}
                    <tr>
                        <td><strong>{{ venda.livro.titulo }}</strong></td>
                        <td>{{ venda.usuario.nome }}</td>
                        <td>R$ {{ "%.2f"|format(venda.preco) }}</td>
                        <td>{{ venda.data_venda.strftime('%d/%m/%Y') }}</td>
                        {% if current_user.is_admin %}
                        <td>
                            <a href="{{ url_for('cancelar_venda', venda_id=venda.id) }}" class="btn btn-sm btn-danger"
                                onclick="return confirm('Cancelar venda de \" {{ venda.livro.titulo }}\"?')">
                                ‚ùå Cancelar
                            </a>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">üí∞ Nenhuma venda registrada.</div>
        {% endif %}
    </div>
</div>

<!-- Acervo de Livros -->
<div class="row mt-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>üìö Acervo de Livros</h4>
            <span class="badge bg-primary">{{ livros|length }} livros</span>
        </div>

        <div class="table-responsive">
            <table class="table table-striped">
                <thead class="table-primary">
                    <tr>
                        <th>T√≠tulo</th>
                        <th>Autor</th>
                        <th>G√™nero</th>
                        <th>Pre√ßo</th>
                        <th>Dispon√≠vel</th>
                        {% if current_user.is_admin %}
                        <th>A√ß√µes</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for livro in livros %}
                    <tr>
                        <td><strong>{{ livro.titulo }}</strong></td>
                        <td>{{ livro.autor }}</td>
                        <td><span class="badge bg-secondary">{{ livro.genero }}</span></td>
                        <td>R$ {{ "%.2f"|format(livro.preco) }}</td>
                        <td>
                            {% if livro.disponivel %}
                            <span class="badge bg-success">‚úÖ Dispon√≠vel</span>
                            {% else %}
                            <span class="badge bg-danger">‚ùå Indispon√≠vel</span>
                            {% endif %}
                        </td>
                        {% if current_user.is_admin %}
                        <td>
                            <a href="{{ url_for('editar_livro', livro_id=livro.id) }}" class="btn btn-sm btn-warning">‚úèÔ∏è
                                Editar</a>
                            <a href="{{ url_for('deletar_livro', livro_id=livro.id) }}" class="btn btn-sm btn-danger"
                                onclick="return confirm('Deletar \" {{ livro.titulo }}\"?')">üóëÔ∏è Deletar</a>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Lista de Usu√°rios (apenas para admin) -->
{% if current_user.is_admin and usuarios %}
<div class="row mt-4">
    <div class="col-12">
        <h4>üë• Usu√°rios do Sistema</h4>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Tipo</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for usuario in usuarios %}
                    <tr>
                        <td>{{ usuario.nome }}</td>
                        <td>{{ usuario.email }}</td>
                        <td>
                            {% if usuario.is_admin %}
                            <span class="badge bg-danger">Administrador</span>
                            {% else %}
                            <span class="badge bg-secondary">Usu√°rio</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('editar_usuario', usuario_id=usuario.id) }}"
                                class="btn btn-sm btn-warning">‚úèÔ∏è Editar</a>
                            {% if usuario.id != current_user.id %}
                            <a href="{{ url_for('deletar_usuario', usuario_id=usuario.id) }}"
                                class="btn btn-sm btn-danger" onclick="return confirm('Deletar usu√°rio \" {{
                                usuario.nome }}\"?')">üóëÔ∏è Deletar</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}